name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Determine what files changed to run appropriate checks
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      tests: ${{ steps.filter.outputs.tests }}
      docs_only: ${{ steps.filter.outputs.docs_only }}
      examples_only: ${{ steps.filter.outputs.examples_only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for relevant changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'packages/**/*.ts'
              - 'plugins/**/*.ts'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - 'tsup.config.ts'
            tests:
              - 'packages/**/*.ts'
              - 'plugins/**/*.ts'
              - '**/*.test.ts'
              - '**/*.spec.ts'
              - 'jest.config.*'
            docs_only:
              - added|modified: '**/*.md'
              - added|modified: 'docs/**'
            examples_only:
              - added|modified: 'examples/**'
              - added|modified: 'tutorials/**'

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: changes
    # Run tests if code/tests changed, or on push to main, always skip for docs-only PRs
    if: |
      needs.changes.outputs.tests == 'true' ||
      github.event_name == 'push'

    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Run tests
        run: npm test

      - name: Run build
        run: npm run build

      - name: Upload coverage
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: false

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: changes
    # Only run benchmarks when code changes, skip for docs/examples/tutorials
    if: |
      needs.changes.outputs.code == 'true' ||
      github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-benchmark-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-benchmark-

      - name: Run benchmarks
        run: npm run benchmark
        continue-on-error: true

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    needs: changes
    # Run lint for code changes; skip for examples/tutorials-only changes
    if: |
      needs.changes.outputs.code == 'true' ||
      needs.changes.outputs.tests == 'true' ||
      github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-lint-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-lint-

      - name: Run typecheck
        run: npm run typecheck

      - name: Run lint
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: changes
    # Only run security audit when dependencies or code change, skip for docs/examples
    if: |
      needs.changes.outputs.code == 'true' ||
      github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate

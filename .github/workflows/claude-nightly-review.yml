name: Claude Nightly Code Review

on:
  schedule:
    # Run at 2:00 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering for testing
    inputs:
      focus_area:
        description: 'Optional: Focus area for the review (e.g., "security", "performance", "all")'
        required: false
        default: 'all'

jobs:
  nightly-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive analysis

      - name: Run Claude Nightly Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            # Nightly Code Review - Full Repository Analysis

            You are conducting a comprehensive nightly code review of the OrionECS repository.
            Focus area: ${{ github.event.inputs.focus_area || 'all' }}

            ## Project Philosophy & Requirements

            **CRITICAL**: OrionECS is a **strict type-safe ECS framework**. All reviews MUST enforce:

            ### Type Safety (Highest Priority)
            - **NO `any` types** - Every value must have explicit types
            - **NO type assertions (`as`)** unless absolutely necessary with justification
            - **NO implicit `any`** - Enable `noImplicitAny` compliance
            - **Use generics** - Type parameters should flow through the system (like EngineAccumulator pattern)
            - **Type inference** - Leverage TypeScript's inference where it strengthens safety
            - **Discriminated unions** - Prefer over loose object types
            - **Const assertions** - Use `as const` for literal types
            - **Type guards** - Implement proper type narrowing with predicates
            - **Template literal types** - For compile-time string validation

            ### ECS Architecture Principles (Critical)
            - **Composition over inheritance** - Entities are composition of components
            - **Data-oriented design** - Components are pure data (POJOs), systems are pure logic
            - **No behavior in components** - Components should not have methods (except constructors)
            - **Systems query for intent** - Use component presence to express intent, not fields
            - **Plugin architecture** - Extend via plugins, not by modifying core
            - **Archetype optimization** - Respect cache locality patterns
            - **Minimal API surface** - Core should be minimal, plugins add features

            ### Anti-Patterns to Flag
            - ‚ùå Components with business logic methods
            - ‚ùå Systems that don't use queries (operating on single entities)
            - ‚ùå Tight coupling between components
            - ‚ùå God entities with too many components
            - ‚ùå Type erasure or loss of type information
            - ‚ùå Runtime type checking that could be compile-time
            - ‚ùå Use of `any`, `unknown` without proper narrowing
            - ‚ùå Type assertions to bypass the type system
            - ‚ùå **Global state in static variables** - Use `engine.setSingleton()` instead
            - ‚ùå Module-level mutable state - State should live in ECS (singletons or components)

            ## Review Scope

            Analyze the entire codebase looking for:

            ### 1. Type Safety Violations (CRITICAL)
            - Any use of `any` type
            - Type assertions (`as`) without clear justification
            - Implicit `any` from missing types
            - Lost type information through generic boundaries
            - Runtime checks that should be compile-time
            - Missing generic constraints
            - Unsafe type narrowing or widening

            ### 2. ECS Architecture Violations (HIGH)
            - Components with methods (behavior in data)
            - Systems not using the query system
            - Entity-specific logic instead of component queries
            - Inheritance hierarchies instead of composition
            - Tight coupling between components
            - Core modifications that should be plugins
            - **Static or module-level state** - Should use `engine.setSingleton()` for global state
            - Mutable state outside the ECS (globals, statics, module variables)

            ### 3. Code Smells
            - Dead code or unused exports
            - Overly complex functions (high cyclomatic complexity)
            - Code duplication
            - Long parameter lists
            - God classes or functions doing too much
            - Magic numbers/strings without constants
            - Poor naming conventions
            - Inconsistent code style

            ### 2. Potential Bugs
            - Null/undefined reference risks
            - Off-by-one errors
            - Race conditions in async code
            - Uncaught promise rejections
            - Type coercion issues
            - Missing error handling
            - Incorrect loop conditions
            - Memory leaks (event listeners, closures)

            ### 3. Security Issues
            - Input validation gaps
            - Injection vulnerabilities
            - Unsafe deserialization
            - Exposed sensitive data
            - Insecure defaults

            ### 4. Potential Bugs
            - Null/undefined reference risks
            - Off-by-one errors
            - Race conditions in async code
            - Uncaught promise rejections
            - Type coercion issues
            - Missing error handling
            - Incorrect loop conditions
            - Memory leaks (event listeners, closures)

            ### 5. Security Issues
            - Input validation gaps
            - Injection vulnerabilities
            - Unsafe deserialization
            - Exposed sensitive data
            - Insecure defaults

            ### 6. Performance Issues
            - Unnecessary iterations or loops
            - Missing memoization opportunities
            - Inefficient data structures
            - Redundant computations
            - Memory-intensive patterns
            - Archetype inefficiencies (entities with frequently changing components)

            ### 7. Architecture & Design
            - SOLID principle violations
            - Circular dependencies
            - Tight coupling between modules
            - Missing abstractions
            - Inconsistent patterns across codebase

            ### 8. Documentation & Maintainability
            - Missing or outdated TSDoc comments
            - Undocumented public APIs (should have TypeDoc coverage)
            - Complex code without explanation
            - Missing or weak TypeScript types

            ## Output Format

            Create a GitHub issue with your findings using `gh issue create`. The issue should:

            1. **Title**: "üîç Nightly Code Review - [DATE]"
            2. **Labels**: `code-review`, `automated`
            3. **Body** should include:
               - Executive summary (1-2 paragraphs)
               - Findings organized by severity (Critical, High, Medium, Low)
               - Each finding should include:
                 - File path and line number(s)
                 - Description of the issue
                 - Suggested fix or improvement
                 - Code snippet if helpful
               - Metrics summary (files reviewed, issues found by category)

            ## Guidelines

            - **CRITICAL**: Prioritize type safety violations above all else - this is a type-safe framework
            - Use the repository's CLAUDE.md for project-specific conventions
            - **ECS principles**: Flag any violations of composition-over-inheritance or data-vs-behavior separation
            - Focus on actionable findings with clear remediation steps
            - Prioritize issues that could cause bugs or security vulnerabilities
            - Skip node_modules, dist, and other build artifacts
            - Be specific - include file paths and line numbers
            - Group related issues together
            - **Examples matter**: Flag anti-patterns in examples/ as HIGH priority (users will copy these)
            - If no significant issues are found, still create an issue with a brief "all clear" summary

            ## Key Directories to Review

            - `packages/core/src/` - Core ECS engine
            - `plugins/*/src/` - All plugin implementations
            - `packages/*/src/` - Supporting packages
            - `examples/` - Example code (check for anti-patterns that users might copy)

          claude_args: '--allowed-tools "Bash(gh issue create:*),Bash(gh issue list:*),Bash(gh label create:*)"'

      - name: Ensure labels exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "code-review" --description "Automated code review findings" --color "7057ff" --force || true
          gh label create "automated" --description "Automatically generated" --color "bfdadc" --force || true

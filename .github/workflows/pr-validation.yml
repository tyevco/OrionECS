name: PR Validation

on:
  pull_request:
    branches:
      - main

jobs:
  # Determine what files changed to run appropriate validations
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs_only: ${{ steps.filter.outputs.docs_only }}
      examples_only: ${{ steps.filter.outputs.examples_only }}
      ci_only: ${{ steps.filter.outputs.ci_only }}
      needs_build: ${{ steps.filter.outputs.needs_build }}
      needs_tests: ${{ steps.filter.outputs.needs_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for relevant changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'packages/**/*.ts'
              - 'plugins/**/*.ts'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - 'tsup.config.ts'
              - 'biome.json'
            docs_only:
              - '**/*.md'
              - 'docs/**'
            examples_only:
              - 'examples/**'
              - 'tutorials/**'
            ci_only:
              - '.github/**'
            needs_build:
              - 'packages/**/*.ts'
              - 'plugins/**/*.ts'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - 'tsup.config.ts'
            needs_tests:
              - 'packages/**/*.ts'
              - 'plugins/**/*.ts'
              - '**/*.test.ts'
              - '**/*.spec.ts'
              - 'jest.config.*'

  # Changeset validation - runs for all PRs
  validate-changeset:
    name: Validate Changeset
    runs-on: ubuntu-latest
    needs: changes
    # Skip for bot PRs (like changeset version PRs)
    if: github.event.pull_request.user.login != 'github-actions[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for changeset
        id: changeset-check
        run: |
          # Run the changeset check script
          if ./scripts/check-changeset.sh origin/${{ github.base_ref }}; then
            echo "result=pass" >> $GITHUB_OUTPUT
          else
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Changeset Summary
        if: always()
        run: |
          if [ "${{ steps.changeset-check.outputs.result }}" == "pass" ]; then
            echo "### ✅ Changeset Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Either a changeset is included or no changeset is required for these changes." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Changeset Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR includes changes to publishable packages but no changeset was found." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please add a changeset:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "npx changeset" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # Full validation for code changes
  validate-code:
    name: Validate Code
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-pr-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-pr-

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Build packages
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Verify build artifacts
        run: |
          echo "Checking core package..."
          test -f packages/core/dist/index.js || (echo "❌ packages/core/dist/index.js not found" && exit 1)
          test -f packages/core/dist/index.d.ts || (echo "❌ packages/core/dist/index.d.ts not found" && exit 1)

          echo "Checking math package..."
          test -f packages/math/dist/index.js || (echo "❌ packages/math/dist/index.js not found" && exit 1)
          test -f packages/math/dist/index.d.ts || (echo "❌ packages/math/dist/index.d.ts not found" && exit 1)

          echo "Checking graphics package..."
          test -f packages/graphics/dist/index.js || (echo "❌ packages/graphics/dist/index.js not found" && exit 1)
          test -f packages/graphics/dist/index.d.ts || (echo "❌ packages/graphics/dist/index.d.ts not found" && exit 1)

          echo "Checking testing package..."
          test -f packages/testing/dist/index.js || (echo "❌ packages/testing/dist/index.js not found" && exit 1)
          test -f packages/testing/dist/index.d.ts || (echo "❌ packages/testing/dist/index.d.ts not found" && exit 1)

          echo "✅ All build artifacts verified"

      - name: PR Summary
        run: |
          echo "### ✅ PR Validation Passed (Full)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Type checking" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Linting" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Formatting" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Tests" >> $GITHUB_STEP_SUMMARY

  # Lightweight validation for docs-only changes
  validate-docs:
    name: Validate Docs
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code != 'true' && needs.changes.outputs.docs_only == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Format check (markdown)
        run: npm run format:check
        continue-on-error: true

      - name: PR Summary
        run: |
          echo "### ✅ PR Validation Passed (Docs Only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Documentation-only changes detected. Lightweight validation passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Skipped checks (not needed for docs):" >> $GITHUB_STEP_SUMMARY
          echo "- ⏭️ Type checking" >> $GITHUB_STEP_SUMMARY
          echo "- ⏭️ Build" >> $GITHUB_STEP_SUMMARY
          echo "- ⏭️ Tests" >> $GITHUB_STEP_SUMMARY

  # Lightweight validation for examples/tutorials changes
  validate-examples:
    name: Validate Examples
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.code != 'true' &&
      needs.changes.outputs.docs_only != 'true' &&
      needs.changes.outputs.examples_only == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages (needed for examples)
        run: npm run build

      - name: Format check
        run: npm run format:check
        continue-on-error: true

      - name: PR Summary
        run: |
          echo "### ✅ PR Validation Passed (Examples Only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Examples/tutorials-only changes detected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checks performed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build (to ensure examples can import packages)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Format check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Skipped checks:" >> $GITHUB_STEP_SUMMARY
          echo "- ⏭️ Full test suite" >> $GITHUB_STEP_SUMMARY

  # CI-only changes (workflow files)
  validate-ci:
    name: Validate CI
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.code != 'true' &&
      needs.changes.outputs.docs_only != 'true' &&
      needs.changes.outputs.examples_only != 'true' &&
      needs.changes.outputs.ci_only == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate workflow files
        run: |
          echo "Checking workflow file syntax..."
          for file in .github/workflows/*.yml; do
            echo "Checking $file..."
            # Basic YAML syntax check
            if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "❌ Invalid YAML syntax in $file"
              exit 1
            fi
          done
          echo "✅ All workflow files have valid YAML syntax"

      - name: PR Summary
        run: |
          echo "### ✅ PR Validation Passed (CI Only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CI/workflow-only changes detected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checks performed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Workflow YAML syntax validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Skipped checks (not needed for CI changes):" >> $GITHUB_STEP_SUMMARY
          echo "- ⏭️ Build" >> $GITHUB_STEP_SUMMARY
          echo "- ⏭️ Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ⏭️ Type checking" >> $GITHUB_STEP_SUMMARY
